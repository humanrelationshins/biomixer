/*******************************************************************************
 * Copyright 2009, 2010 Lars Grammel 
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); 
 * you may not use this file except in compliance with the License. 
 * You may obtain a copy of the License at 
 *
 *    http://www.apache.org/licenses/LICENSE-2.0 
 *     
 * Unless required by applicable law or agreed to in writing, software 
 * distributed under the License is distributed on an "AS IS" BASIS, 
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. 
 * See the License for the specific language governing permissions and 
 * limitations under the License.  
 *******************************************************************************/
package org.thechiselgroup.biomixer.client.workbench.ui.configuration;

import static org.thechiselgroup.biomixer.client.core.configuration.ChooselInjectionConstants.AVATAR_FACTORY_ALL_RESOURCES;
import static org.thechiselgroup.biomixer.client.core.configuration.ChooselInjectionConstants.AVATAR_FACTORY_SELECTION;
import static org.thechiselgroup.biomixer.client.core.configuration.ChooselInjectionConstants.AVATAR_FACTORY_SELECTION_DROP;
import static org.thechiselgroup.biomixer.client.core.configuration.ChooselInjectionConstants.AVATAR_FACTORY_SET;
import static org.thechiselgroup.biomixer.client.core.configuration.ChooselInjectionConstants.DROP_TARGET_MANAGER_VIEW_CONTENT;
import static org.thechiselgroup.biomixer.client.core.configuration.ChooselInjectionConstants.LABEL_PROVIDER_SELECTION_SET;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;

import org.thechiselgroup.biomixer.client.core.command.CommandManager;
import org.thechiselgroup.biomixer.client.core.error_handling.ErrorHandler;
import org.thechiselgroup.biomixer.client.core.error_handling.ThrowableCaught;
import org.thechiselgroup.biomixer.client.core.error_handling.ThrowablesContainer;
import org.thechiselgroup.biomixer.client.core.error_handling.ThrowablesContainerErrorHandler;
import org.thechiselgroup.biomixer.client.core.label.LabelProvider;
import org.thechiselgroup.biomixer.client.core.resources.DefaultResourceSetFactory;
import org.thechiselgroup.biomixer.client.core.resources.HasResourceCategorizer;
import org.thechiselgroup.biomixer.client.core.resources.ResourceByUriMultiCategorizer;
import org.thechiselgroup.biomixer.client.core.resources.ResourceMultiCategorizer;
import org.thechiselgroup.biomixer.client.core.resources.ResourceSetFactory;
import org.thechiselgroup.biomixer.client.core.resources.ui.DetailsWidgetHelper;
import org.thechiselgroup.biomixer.client.core.resources.ui.ResourceSetAvatarFactory;
import org.thechiselgroup.biomixer.client.core.resources.ui.ResourceSetAvatarResourceSetsPresenter;
import org.thechiselgroup.biomixer.client.core.ui.SidePanelSection;
import org.thechiselgroup.biomixer.client.core.ui.popup.PopupManagerFactory;
import org.thechiselgroup.biomixer.client.core.ui.widget.listbox.ErrorListBoxFactory;
import org.thechiselgroup.biomixer.client.core.ui.widget.listbox.ExtendedListBox;
import org.thechiselgroup.biomixer.client.core.ui.widget.listbox.ListBoxControl;
import org.thechiselgroup.biomixer.client.core.util.DisposeUtil;
import org.thechiselgroup.biomixer.client.core.util.collections.CollectionFactory;
import org.thechiselgroup.biomixer.client.core.util.collections.LightweightList;
import org.thechiselgroup.biomixer.client.core.util.date.GwtDateTimeFormatFactory;
import org.thechiselgroup.biomixer.client.core.visualization.ViewTopBarExtension;
import org.thechiselgroup.biomixer.client.core.visualization.DefaultView;
import org.thechiselgroup.biomixer.client.core.visualization.CenterRightViewTopBarExtension;
import org.thechiselgroup.biomixer.client.core.visualization.LeftViewTopBarExtension;
import org.thechiselgroup.biomixer.client.core.visualization.ViewPart;
import org.thechiselgroup.biomixer.client.core.visualization.behaviors.CompositeVisualItemBehavior;
import org.thechiselgroup.biomixer.client.core.visualization.behaviors.HighlightingVisualItemBehavior;
import org.thechiselgroup.biomixer.client.core.visualization.behaviors.PopupWithHighlightingVisualItemBehavior;
import org.thechiselgroup.biomixer.client.core.visualization.behaviors.SwitchSelectionOnClickVisualItemBehavior;
import org.thechiselgroup.biomixer.client.core.visualization.model.Slot;
import org.thechiselgroup.biomixer.client.core.visualization.model.ViewContentDisplay;
import org.thechiselgroup.biomixer.client.core.visualization.model.VisualItemValueResolver;
import org.thechiselgroup.biomixer.client.core.visualization.model.VisualizationModel;
import org.thechiselgroup.biomixer.client.core.visualization.model.extensions.DefaultResourceModel;
import org.thechiselgroup.biomixer.client.core.visualization.model.extensions.DefaultSelectionModel;
import org.thechiselgroup.biomixer.client.core.visualization.model.extensions.HighlightingModel;
import org.thechiselgroup.biomixer.client.core.visualization.model.extensions.RequiresAutomaticResourceSet;
import org.thechiselgroup.biomixer.client.core.visualization.model.extensions.ResourceModel;
import org.thechiselgroup.biomixer.client.core.visualization.model.implementation.DefaultVisualizationModel;
import org.thechiselgroup.biomixer.client.core.visualization.model.implementation.FixedSlotResolversVisualizationModelDecorator;
import org.thechiselgroup.biomixer.client.core.visualization.model.initialization.ViewContentDisplaysConfiguration;
import org.thechiselgroup.biomixer.client.core.visualization.model.managed.DefaultManagedSlotMappingConfiguration;
import org.thechiselgroup.biomixer.client.core.visualization.model.managed.DefaultSlotMappingInitializer;
import org.thechiselgroup.biomixer.client.core.visualization.model.managed.ManagedSlotMappingConfigurationChangedEvent;
import org.thechiselgroup.biomixer.client.core.visualization.model.managed.ManagedSlotMappingConfigurationChangedEventHandler;
import org.thechiselgroup.biomixer.client.core.visualization.model.managed.SlotMappingInitializer;
import org.thechiselgroup.biomixer.client.core.visualization.model.managed.VisualItemValueResolverFactoryProvider;
import org.thechiselgroup.biomixer.client.core.visualization.model.persistence.ManagedSlotMappingConfigurationPersistence;
import org.thechiselgroup.biomixer.client.core.visualization.resolvers.ui.VisualItemValueResolverUIControllerFactoryProvider;
import org.thechiselgroup.biomixer.client.core.visualization.ui.DefaultResourceModelPresenter;
import org.thechiselgroup.biomixer.client.core.visualization.ui.DefaultSelectionModelPresenter;
import org.thechiselgroup.biomixer.client.core.visualization.ui.DefaultVisualMappingsControl;
import org.thechiselgroup.biomixer.client.core.visualization.ui.VisualMappingsControl;
import org.thechiselgroup.biomixer.client.dnd.resources.DragEnablerFactory;
import org.thechiselgroup.biomixer.client.dnd.resources.DragVisualItemBehavior;
import org.thechiselgroup.biomixer.client.dnd.resources.DropEnabledViewContentDisplay;
import org.thechiselgroup.biomixer.client.dnd.resources.ResourceSetAvatarDropTargetManager;
import org.thechiselgroup.biomixer.client.dnd.windows.ViewWindowContent;
import org.thechiselgroup.biomixer.client.dnd.windows.WindowContent;
import org.thechiselgroup.biomixer.client.dnd.windows.WindowContentProducer;

import com.google.inject.Inject;
import com.google.inject.name.Named;

// TODO how can we make the whole build process configuration more flexible? patterns?
public class ViewWindowContentProducer implements WindowContentProducer {

    @Inject
    @Named(AVATAR_FACTORY_ALL_RESOURCES)
    private ResourceSetAvatarFactory allResourcesDragAvatarFactory;

    @Inject
    @Named(DROP_TARGET_MANAGER_VIEW_CONTENT)
    private ResourceSetAvatarDropTargetManager contentDropTargetManager;

    @Inject
    @Named(AVATAR_FACTORY_SELECTION_DROP)
    private ResourceSetAvatarFactory dropTargetFactory;

    @Inject
    private ResourceSetFactory resourceSetFactory;

    @Inject
    @Named(AVATAR_FACTORY_SELECTION)
    private ResourceSetAvatarFactory selectionDragAvatarFactory;

    @Inject
    @Named(LABEL_PROVIDER_SELECTION_SET)
    private LabelProvider selectionModelLabelFactory;

    @Inject
    @Named(AVATAR_FACTORY_SET)
    private ResourceSetAvatarFactory userSetsDragAvatarFactory;

    @Inject
    private ViewContentDisplaysConfiguration viewContentDisplayConfiguration;

    @Inject
    private HighlightingModel hoverModel;

    @Inject
    protected VisualItemValueResolverUIControllerFactoryProvider uiProvider;

    @Inject
    private PopupManagerFactory popupManagerFactory;

    @Inject
    private DetailsWidgetHelper detailsWidgetHelper;

    @Inject
    private DragEnablerFactory dragEnablerFactory;

    @Inject
    private CommandManager commandManager;

    @Inject
    private ErrorHandler errorHandler;

    // XXX how does disposeUtil get setup with the correct error handler?
    @Inject
    private DisposeUtil disposeUtil;

    @Inject
    protected VisualItemValueResolverFactoryProvider resolverFactoryProvider;

    @Inject
    private ManagedSlotMappingConfigurationPersistence slotMappingConfigurationPersistence;

    /**
     * Hook for overriding.
     */
    protected List<ViewTopBarExtension> createViewTopBarExtensions(
            ResourceModel resourceModel, DefaultSelectionModel selectionModel) {

        List<ViewTopBarExtension> extensions = new ArrayList<ViewTopBarExtension>();

        extensions.add(createResourceModelPresenterExtension(resourceModel));
        extensions.add(createSelectionModelPresenterExtension(selectionModel));

        return extensions;
    }

    protected ResourceMultiCategorizer createDefaultCategorizer(
            String contentType) {
        return new ResourceByUriMultiCategorizer();
    }

    private ViewTopBarExtension createResourceModelPresenterExtension(
            ResourceModel resourceModel) {

        return new LeftViewTopBarExtension(
                new DefaultResourceModelPresenter(
                        new ResourceSetAvatarResourceSetsPresenter(
                                allResourcesDragAvatarFactory),
                        new ResourceSetAvatarResourceSetsPresenter(
                                userSetsDragAvatarFactory), resourceModel));
    }

    private ViewTopBarExtension createSelectionModelPresenterExtension(
            DefaultSelectionModel selectionModel) {

        return new CenterRightViewTopBarExtension(
                new DefaultSelectionModelPresenter(
                        new ResourceSetAvatarResourceSetsPresenter(
                                dropTargetFactory),
                        new ResourceSetAvatarResourceSetsPresenter(
                                selectionDragAvatarFactory), selectionModel));
    }

    // XXX remove
    protected LightweightList<SidePanelSection> createSidePanelSections(
            String contentType, ViewContentDisplay contentDisplay,
            VisualMappingsControl visualMappingsControl,
            ResourceModel resourceModel, VisualizationModel visualizationModel) {

        LightweightList<SidePanelSection> sidePanelSections = CollectionFactory
                .createLightweightList();

        sidePanelSections.add(new SidePanelSection("Mappings",
                visualMappingsControl.asWidget()));
        sidePanelSections.addAll(contentDisplay.getSidePanelSections());

        return sidePanelSections;
    }

    protected SlotMappingInitializer createSlotMappingInitializer(
            String contentType) {
        return new DefaultSlotMappingInitializer();
    }

    /**
     * Hook method that should be overridden to provide customized view parts.
     */
    protected LightweightList<ViewPart> createViewParts(String contentType) {
        return CollectionFactory.createLightweightList();
    }

    protected VisualMappingsControl createVisualMappingsControl(
            HasResourceCategorizer resourceGrouping,
            DefaultManagedSlotMappingConfiguration uiModel, String contentType) {

        // TODO change configuration to configurationUIModel
        return new DefaultVisualMappingsControl(uiModel, resourceGrouping,
                this.uiProvider, resolverFactoryProvider, errorHandler);
    }

    @Override
    public WindowContent createWindowContent(String contentType) {
        assert contentType != null;

        ThrowablesContainer throwablesContainer = new ThrowablesContainer();
        ErrorHandler throwablesContainerErrorHandler = new ThrowablesContainerErrorHandler(
                throwablesContainer);
        ViewContentDisplay viewContentDisplay = viewContentDisplayConfiguration
                .createDisplay(contentType, throwablesContainerErrorHandler);

        ViewContentDisplay contentDisplay = new DropEnabledViewContentDisplay(
                viewContentDisplay, contentDropTargetManager);

        ResourceModel resourceModel = new DefaultResourceModel(
                resourceSetFactory);

        if (viewContentDisplay instanceof RequiresAutomaticResourceSet) {
            ((RequiresAutomaticResourceSet) viewContentDisplay)
                    .setAutomaticResources(resourceModel
                            .getAutomaticResourceSet());
        }

        DefaultSelectionModel selectionModel = new DefaultSelectionModel(
                selectionModelLabelFactory, resourceSetFactory);

        Map<Slot, VisualItemValueResolver> fixedSlotResolvers = viewContentDisplayConfiguration
                .getFixedSlotResolvers(contentType);

        CompositeVisualItemBehavior visualItemBehaviors = new CompositeVisualItemBehavior();

        // visualItemBehaviors.add(new ViewInteractionLogger(logger));
        visualItemBehaviors.add(new HighlightingVisualItemBehavior(hoverModel,
                disposeUtil));
        visualItemBehaviors.add(new DragVisualItemBehavior(dragEnablerFactory,
                disposeUtil));
        visualItemBehaviors.add(new PopupWithHighlightingVisualItemBehavior(
                detailsWidgetHelper, popupManagerFactory, hoverModel,
                disposeUtil));
        visualItemBehaviors.add(new SwitchSelectionOnClickVisualItemBehavior(
                selectionModel, commandManager));

        SlotMappingInitializer slotMappingInitializer = createSlotMappingInitializer(contentType);

        ResourceMultiCategorizer categorizer = createDefaultCategorizer(contentType);

        VisualizationModel visualizationModel = new FixedSlotResolversVisualizationModelDecorator(
                new DefaultVisualizationModel(contentDisplay,
                        selectionModel.getSelectionProxy(),
                        hoverModel.getResources(), visualItemBehaviors,
                        throwablesContainerErrorHandler,
                        new DefaultResourceSetFactory(), categorizer,
                        disposeUtil), fixedSlotResolvers);

        visualizationModel.setContentResourceSet(resourceModel.getResources());

        DefaultManagedSlotMappingConfiguration managedConfiguration = new DefaultManagedSlotMappingConfiguration(
                resolverFactoryProvider, slotMappingInitializer,
                visualizationModel, visualizationModel);

        /**
         * Visual Mappings Control is what sets up the side panel section that
         * handles mapping the slot to its resolvers.
         * 
         */
        final VisualMappingsControl visualMappingsControl = createVisualMappingsControl(
                visualizationModel, managedConfiguration, contentType);
        assert visualMappingsControl != null : "createVisualMappingsControl must not return null";

        LightweightList<ViewPart> viewParts = createViewParts(contentType);

        LightweightList<SidePanelSection> sidePanelSections = createSidePanelSections(
                contentType, contentDisplay, visualMappingsControl,
                resourceModel, visualizationModel);

        for (ViewPart viewPart : viewParts) {
            viewPart.addSidePanelSections(sidePanelSections);
        }

        String label = contentDisplay.getName();

        managedConfiguration
                .addManagedSlotMappingConfigurationChangedEventHandler(new ManagedSlotMappingConfigurationChangedEventHandler() {
                    @Override
                    public void onSlotMappingStateChanged(
                            ManagedSlotMappingConfigurationChangedEvent event) {
                        visualMappingsControl
                                .updateConfigurationForSlotMappingChangedEvent(event);

                    }
                });

        // TODO: inject GwtDateTimeFormatFactory
        ListBoxControl<ThrowableCaught> listBoxControl = ErrorListBoxFactory
                .createErrorBox(throwablesContainer, new ExtendedListBox(),
                        new GwtDateTimeFormatFactory(), errorHandler);

        DefaultView view = new DefaultView(contentDisplay, label, contentType,
                visualMappingsControl, sidePanelSections, visualizationModel,
                resourceModel, selectionModel, managedConfiguration,
                slotMappingConfigurationPersistence, disposeUtil,
                listBoxControl);

        for (ViewTopBarExtension extension : createViewTopBarExtensions(
                resourceModel, selectionModel)) {
            view.addTopBarExtension(extension);
        }

        for (ViewPart viewPart : viewParts) {
            viewPart.afterViewCreation(view);
        }

        return new ViewWindowContent(view);
    }
}